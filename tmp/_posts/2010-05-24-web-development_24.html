---
layout: post
title: "Web development: Интеграционное тестирование страниц"
date: 2010-05-24T21:52:00+03:00
comments: false
categories:
 - asp.net
 - TDD
---

<div class='post'>
Интеграцинный тест, это тест, который осуществляет проверку работоспобности объекта или совокупности объектов. В отличии от юнит теста, где фокусом тестирования выспупает метод (методы), в интеграционном тестировании фокусом есть объект (объекты).
<br />
<br />
<h2>Подготовка</h2>
<br />
<br />
В солюшине уже есть проект под названием WebApplication.Tests, именно он будет содержать тесты страниц и контролов веб приложения. Пока что в он пустой, и перед тем как добавить первый тест, необходимы некоторые подготовительные действия. 
Во первых, необходимо включить в проект HttpSimulator (о нем я писал в прошлой статье), как крайне удобное средство тестирования веб страниц без веб сервера (Serverless testing). С HtppSimulator можно ознакомиться на странице автора, Фила Хаака (одного из разработчиков ASP.net MVC). Кстати линк, по которому были доступны исходники уже не валидный, поэтому HtppSimulator можно скачать <a href="http://docs.google.com/leaf?id0Bz70dGvwjh5zYWQzYTNlNGQtOGFkZi00MGIwLWJhOWYtYWQ4YzA4MWNlZGI1&hl=en">здесь</a>. Забегая вперед, отмечу, что в случае тестирования страницы регистрации, использование HtppSimulator не является необходим, однако лучше подготовить необходимый фреймворк сразу.
<br />
<br />
Интеграционный тест на то и интеграционный, что в нем задействованы все компоненты "в живую". Использование моков и стабов в интеграцинном тестировании противоречит его смыслу. Так как приложение обращается к базе данных, мы должны уметь правильно подготовить и удалить после себя те данные, которые нужны для теста. Поэтому мы должны имееть класс DbScript, который будет готовить и очищать тестовые данные. 
<br />
<br />
Начиная работать с тестами в С++, мне очень нравился поход, который опирался на гарантированный вызов конструктора/деструктора объекта, поэтому можно было проектировать базовые классы, выполняющие инициализвацию и очистку ресурсов, а каждый тест инкапусулировать в класс, наследующий его. Таким образом, перед запуском мы выполняли подготовку, и чтобы не случилось во время выполнения теста, будет вызван деструктор, завершающий тестовую сессию. В .NET ситуация иная, просто потому что в нем нет явных деструкторов.. а тесты в NUnit это не классы, а методы класса TestFixture. Конечно, в NUnit есть методы SetUp/TearDown, но они обощенный на уровне класса, и не подходят в тех случаях, когда, напрмер каждому тесту необходима уникальная инициализация. Тем не менее, мы может симулировать подобное поведение. Для этого мы добавим новый класс FixtureInit, реализующий интрефейс IDisposable, который будет инициализирован в using блоке, внутри каждого теста.
<br />
<br />
Наконец сам код страницы необходимо немного изменить, дабы привести ее к виду пригодному для тестирования.
<br />
<br />
<h3>Http Simulator integration</h3>
<br />
<br />
Сам проект состоит из 4-х файлов, включая тесты, поэтому просто довим их в WebApplication.Test в фолдер HttpSimulator. 
<br />
<br />
<h3>DbScript class</h3>
<br />
<br />
Пока что, это пустой класс с методами Init и Clean.
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">using</font> System;<br><font color="#0000ff">using</font> System.Collections.<font color="#2B91AF">Generic</font>;<br><font color="#0000ff">using</font> System.Linq;<br><font color="#0000ff">using</font> System.Text;<br><br><font color="#0000ff">namespace</font> WebApplication.Tests.Framework<br>{<br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">class</font> DbScript : IDisposable<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> DbScript()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Init();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> <font color="#0000ff">void</font> Init()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#region</font> IDisposable Members<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> Dispose()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Clean();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> <font color="#0000ff">void</font> Clean()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#endregion</font><br>&nbsp;&nbsp;}<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
<h3>FixtureInit class</h3>
<br />
<br />
Класс FixtureInit в конструкторе инициализиует HtppSimulator, а в методе Dispose закрывает его.
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">using</font> System;<br><font color="#0000ff">using</font> System.Collections.<font color="#2B91AF">Generic</font>;<br><font color="#0000ff">using</font> System.Linq;<br><font color="#0000ff">using</font> System.Text;<br><font color="#0000ff">using</font> R1UnitTest.HtttpSimulator;<br><br><font color="#0000ff">namespace</font> WebApplication.Tests.Framework<br>{<br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">class</font> FixtutureInit : IDisposable<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> HttpSimulator _simulator;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> DbScript _script;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> FixtutureInit(<font color="#0000ff">string</font> uri)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_simulator = <font color="#0000ff">new</font> HttpSimulator().SimulateRequest(<font color="#0000ff">new</font> <font color="#2B91AF">Uri</font>(uri));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_script = <font color="#0000ff">new</font> DbScript();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> HttpSimulator Simulator <br>&nbsp;&nbsp;&nbsp;&nbsp;{ <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">get</font> { <font color="#0000ff">return</font> _simulator; } <br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#region</font> IDisposable Members<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> Dispose()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_simulator.Dispose();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_script.Dispose();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#endregion</font><br>&nbsp;&nbsp;}<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
<h3>RegistrationPageTests class</h3>
<br />
<br />
Добавим класс тестов страницы:
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">using</font> System;<br><font color="#0000ff">using</font> System.Collections.<font color="#2B91AF">Generic</font>;<br><font color="#0000ff">using</font> System.Linq;<br><font color="#0000ff">using</font> System.Text;<br><font color="#0000ff">using</font> NUnit.Framework;<br><font color="#0000ff">using</font> WebApplication.Tests.Framework;<br><br><font color="#0000ff">namespace</font> WebApplication.Tests.Tests<br>{<br>&nbsp;&nbsp;[TestFixture]<br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">class</font> RegistrationPageTests<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;[Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> Smoke()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">using</font> (<font color="#0000ff">var</font> fixture = <font color="#0000ff">new</font> FixtutureInit(<font color="#A31515">"http://localhost/registration.aspx"</font>))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> page = <font color="#0000ff">new</font> RegistrationView();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
<h3>Registration.aspx.cs changes</h3>
<br />
<br />
Добавим новый метод _Page_Load, и изменим существующий, для поддержки работы страницы в тестовом и продакшн моде.
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">protected</font> <font color="#0000ff">void</font> Page_Load(<font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e)<br>{<br>&nbsp;&nbsp;<font color="#0000ff">var</font> controls = <font color="#0000ff">new</font> Dictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; {<br>&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"EmailText"</font>, EmailText },<br>&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SecretPhraseText"</font>, SecretPhraseText },<br>&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"PasswordText"</font>, PasswordText }<br>&nbsp;&nbsp;};<br><br>&nbsp;&nbsp;<font color="#0000ff">var</font> postback = <font color="#2B91AF">Page</font>.IsPostBack;<br><br>&nbsp;&nbsp;_Page_Load(<font color="#2B91AF">HttpContext</font>.Current, controls, sender, e, postback);<br>}<br><br><font color="#0000ff">public</font> <font color="#0000ff">void</font> _Page_Load(<font color="#2B91AF">HttpContext</font> context, IDictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; controls, <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e, <font color="#0000ff">bool</font> postback)<br>{<br>&nbsp;&nbsp;_registration = <font color="#0000ff">new</font> Registration(<font color="#0000ff">this</font>, <font color="#0000ff">new</font> RegistrationData());<br><br>&nbsp;&nbsp;<font color="#0000ff">if</font> (postback)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;_registration.RegisterUser(EmailText.Text, SecretPhraseText.Text, PasswordText.Text);<br>&nbsp;&nbsp;}<br><br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
<h2>Реализация</h2>
<br />
<br />
<h3>Загрузка страницы</h3>
<br />
<br />
Все готово к запуску первого теста, тест PageLoad выполняет проверку, что загрузка страницы происходит без исключений.
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black">[Test]<br><font color="#0000ff">public</font> <font color="#0000ff">void</font> PageLoad()<br>{<br>&nbsp;&nbsp;<font color="#0000ff">using</font> (<font color="#0000ff">var</font> fixture = <font color="#0000ff">new</font> FixtutureInit(<font color="#A31515">"http://localhost/registration.aspx"</font>))<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//INIT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> page = <font color="#0000ff">new</font> RegistrationView();<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> controls = CreateControls();<br>&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//ACT/POST</font><br>&nbsp;&nbsp;&nbsp;&nbsp;page._Page_Load(<font color="#2B91AF">HttpContext</font>.Current, controls, <font color="#0000ff">new</font> <font color="#0000ff">object</font>(), <font color="#0000ff">new</font> <font color="#2B91AF">EventArgs</font>(), <font color="#0000ff">false</font>);<br>&nbsp;&nbsp;}<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
Метод CreateControls создает словарь используемых на странице контролов:
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">#region</font> common test code<br><font color="#0000ff">private</font> IDictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; CreateControls()<br>{<br>&nbsp;&nbsp;<font color="#0000ff">var</font> controls = <font color="#0000ff">new</font> Dictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; {<br>&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"EmailText"</font>, <font color="#0000ff">new</font> TextBox() },<br>&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SecretPhraseText"</font>, <font color="#0000ff">new</font> TextBox() },<br>&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"PasswordText"</font>, <font color="#0000ff">new</font> TextBox() }<br>&nbsp;&nbsp;};<br><br>&nbsp;&nbsp;<font color="#0000ff">return</font> controls;<br>}<br><font color="#0000ff">#endregion</font><br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
Запустим тест и убедимся, что все ОК.
<br />
<br />
<h3>Проверка регистрации</h3>
<br />
<br />
Теперь сделаем более полезный тест, который сможет проверить функциональность регистрации нового пользователя. Код теста следующий.
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black">[Test]<br><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser()<br>{<br>&nbsp;&nbsp;<font color="#0000ff">using</font> (<font color="#0000ff">var</font> fixture = <font color="#0000ff">new</font> FixtutureInit(<font color="#A31515">"http://localhost/registration.aspx"</font>))<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//INIT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> page = <font color="#0000ff">new</font> RegistrationView();<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> controls = CreateControls();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"EmailText"</font>] <font color="#0000ff">as</font> TextBox).Text = <font color="#A31515">"abe@test.com"</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"SecretPhraseText"</font>] <font color="#0000ff">as</font> TextBox).Text = <font color="#A31515">"bla-bla"</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"PasswordText"</font>] <font color="#0000ff">as</font> TextBox).Text = <font color="#A31515">"test_pass1"</font>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//ACT (post back)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;page._Page_Load(<font color="#2B91AF">HttpContext</font>.Current, controls, <font color="#0000ff">new</font> <font color="#0000ff">object</font>(), <font color="#0000ff">new</font> <font color="#2B91AF">EventArgs</font>(), <font color="#0000ff">true</font>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//POST</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> expected = <font color="#A31515">@"Congratulations! You've been successfully registered on Web Developement web site.&#60;br /&#62;&#60;br /&#62;Return to &#60;a href="</font><font color="#A31515">"Default.aspx"</font><font color="#A31515">"&#62;Main page&#60;/a&#62;."</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;Assert.That((controls[<font color="#A31515">"SuccessMessage"</font>] <font color="#0000ff">as</font> HtmlGenericControl).InnerHtml, Is.EqualTo(expected));<br>&nbsp;&nbsp;&nbsp;&nbsp;Assert.That((controls[<font color="#A31515">"RegistrationMultiView"</font>] <font color="#0000ff">as</font> MultiView).GetActiveView(), Is.EqualTo((controls[<font color="#A31515">"SuccessForm"</font>] <font color="#0000ff">as</font> View)));<br>&nbsp;&nbsp;}<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br />
<br />
Мы выполняем проверку на то, что контрол содержит корректный HTML код и малтивью находится в правильном состоянии. Для того, чтобы этот тест мог быть собран и начал проходить, необходимо внести ряд изменений.
<ul>
    <li>Добавить все необходимые контролы, как в тесте так и на самой странице, в контейнер контролов</li>
    <li>Код страниц изменить таким образом, чтобы доступ был к контролам осуществляся только через этот контейнер</li>
</ul>
Вот как выглядит код страницы, адаптированной под интеграционный тест.<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">public</font> <font color="#0000ff">partial</font> <font color="#0000ff">class</font> RegistrationView : System.Web.UI.<font color="#2B91AF">Page</font>, IRegistrationView<br>{<br>&nbsp;&nbsp;<font color="#0000ff">private</font> Registration _registration;<br>&nbsp;&nbsp;<font color="#0000ff">private</font> IDictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; _controls;<br><br>&nbsp;&nbsp;<font color="#0000ff">protected</font> <font color="#0000ff">void</font> Page_Load(<font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> controls = <font color="#0000ff">new</font> Dictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"RegistrationMultiView"</font>, RegistrationMultiView },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"RegistrationForm"</font>, RegistrationForm },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"EmailText"</font>, EmailText },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SecretPhraseText"</font>, SecretPhraseText },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"PasswordText"</font>, PasswordText },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SuccessForm"</font>, SuccessForm },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SuccessMessage"</font>, SuccessMessage },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"FailedForm"</font>, FailedForm },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"FailMessage"</font>, FailMessage }<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> postback = <font color="#2B91AF">Page</font>.IsPostBack;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;_Page_Load(<font color="#2B91AF">HttpContext</font>.Current, controls, sender, e, postback);<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> _Page_Load(<font color="#2B91AF">HttpContext</font> context, IDictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; controls, <font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e, <font color="#0000ff">bool</font> postback)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;_registration = <font color="#0000ff">new</font> Registration(<font color="#0000ff">this</font>, <font color="#0000ff">new</font> RegistrationData());<br>&nbsp;&nbsp;&nbsp;&nbsp;_controls = controls;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">if</font> (postback)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> email = (_controls[<font color="#A31515">"EmailText"</font>] <font color="#0000ff">as</font> TextBox).Text;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> password = (_controls[<font color="#A31515">"PasswordText"</font>] <font color="#0000ff">as</font> TextBox).Text;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> secret = (_controls[<font color="#A31515">"SecretPhraseText"</font>] <font color="#0000ff">as</font> TextBox).Text;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_registration.RegisterUser(email, secret, password);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<font color="#0000ff">#region</font> IRegistrationView Members<br><br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> Success()<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> successMessageControl = _controls[<font color="#A31515">"SuccessMessage"</font>] <font color="#0000ff">as</font> HtmlGenericControl;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> multiViewControl = _controls[<font color="#A31515">"RegistrationMultiView"</font>] <font color="#0000ff">as</font> MultiView;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;successMessageControl.InnerHtml = <font color="#A31515">@"Congratulations! You've been successfully registered on Web Developement web site."</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;successMessageControl.InnerHtml += <font color="#A31515">@"&#60;br /&#62;&#60;br /&#62;Return to &#60;a href="</font><font color="#A31515">"Default.aspx"</font><font color="#A31515">"&#62;Main page&#60;/a&#62;."</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;multiViewControl.SetActiveView(_controls[<font color="#A31515">"SuccessForm"</font>] <font color="#0000ff">as</font> View);<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> Fail(<font color="#0000ff">string</font> p)<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> failMessageControl = _controls[<font color="#A31515">"FailMessage"</font>] <font color="#0000ff">as</font> HtmlGenericControl;<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> multiViewControl = _controls[<font color="#A31515">"RegistrationMultiView"</font>] <font color="#0000ff">as</font> MultiView;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;failMessageControl.InnerHtml = p;<br>&nbsp;&nbsp;&nbsp;&nbsp;failMessageControl.InnerHtml += <font color="#A31515">"&#60;br /&#62;&#60;br /&#62;Please try register again."</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;multiViewControl.SetActiveView(_controls[<font color="#A31515">"FailedForm"</font>] <font color="#0000ff">as</font> View);<br>&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;<font color="#0000ff">#endregion</font><br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br />
<br />
Хочу отметить, что в реалной разработке, руководствуясь TDD, я сразу пишу код страницы таким образом, чтобы ее можно было тестировать. Т.е. сразу добавляю метод _Page_Load и контейнер контролов. Доступ к контролам, только через объект из контейнера.
<br />
<br />
Есть еще один тонкий момент. Если запустить тест сейчас, то он упадет с исключением, что невозможно установить View в MultiView, потому как данный View не есть Sub View, данного MultiView. Это вполне логично, и для того чтобы это исправить, необходимо подкорректировать метод инициализации контролов в тесте:
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">namespace</font> WebApplication.Tests.Tests<br>{<br>&nbsp;&nbsp;[TestFixture]<br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">class</font> RegistrationPageTests<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#region</font> common test code<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> IDictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; CreateControls()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> controls = <font color="#0000ff">new</font> Dictionary&#60;<font color="#0000ff">string</font>, <font color="#0000ff">object</font>&#62; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"RegistrationMultiView"</font>, <font color="#0000ff">new</font> MultiView() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"RegistrationForm"</font>, <font color="#0000ff">new</font> View() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"EmailText"</font>, <font color="#0000ff">new</font> TextBox() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SecretPhraseText"</font>, <font color="#0000ff">new</font> TextBox() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"PasswordText"</font>, <font color="#0000ff">new</font> TextBox() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SuccessForm"</font>, <font color="#0000ff">new</font> View() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"SuccessMessage"</font>, <font color="#0000ff">new</font> HtmlGenericControl() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"FailedForm"</font>, <font color="#0000ff">new</font> View() },<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <font color="#A31515">"FailMessage"</font>, <font color="#0000ff">new</font> HtmlGenericControl() }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"RegistrationMultiView"</font>] <font color="#0000ff">as</font> MultiView).Views.Add(controls[<font color="#A31515">"RegistrationForm"</font>] <font color="#0000ff">as</font> View);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"RegistrationMultiView"</font>] <font color="#0000ff">as</font> MultiView).Views.Add(controls[<font color="#A31515">"SuccessForm"</font>] <font color="#0000ff">as</font> View);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"RegistrationMultiView"</font>] <font color="#0000ff">as</font> MultiView).Views.Add(controls[<font color="#A31515">"FailedForm"</font>] <font color="#0000ff">as</font> View);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">return</font> controls;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#endregion</font><br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
<h3>DbScript again</h3>
<br />
<br />
Наконец, тест может быть запущен, и он успешно пройдет.. но только один раз, на следующем запуске мы получим фейл. Все просто, мы зарегистрировали пользователя и теперь пытаемся зарегестрировать его снова, что противоречит требованиям. Тут как раз нам пригодиться класс DbScript, а именно: мы добавим в него код, который будет удалять созданную тестами запись. DbScript будет работать через туже модель, которую мы создали ранее. CleanUp удаляет все записи, в которых пароль начинается на "test".
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">using</font> System;<br><font color="#0000ff">using</font> System.Collections.<font color="#2B91AF">Generic</font>;<br><font color="#0000ff">using</font> System.Linq;<br><font color="#0000ff">using</font> System.Text;<br><font color="#0000ff">using</font> Company.Product.DAL;<br><br><font color="#0000ff">namespace</font> WebApplication.Tests.Framework<br>{<br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">class</font> DbScript : IDisposable<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> WebSiteModelDataContext _model = <font color="#0000ff">new</font> WebSiteModelDataContext();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> DbScript()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Init();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> <font color="#0000ff">void</font> Init()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#region</font> IDisposable Members<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> Dispose()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Clean();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> <font color="#0000ff">void</font> Clean()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeleteTestUsers();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> <font color="#0000ff">void</font> DeleteTestUsers()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> users = <font color="#0000ff">from</font> u <font color="#0000ff">in</font> _model.Users <font color="#0000ff">where</font> u.Password.StartsWith(<font color="#A31515">@"test"</font>) <font color="#0000ff">select</font> u;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_model.Users.DeleteAllOnSubmit&#60;User&#62;(users);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_model.SubmitChanges();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">#endregion</font><br>&nbsp;&nbsp;}<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
<h3>Tests, test, test</h3>
<br />
<br />
Следующий тест, который уже явно проверяет фейл процесса регистрации.
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black">[Test]<br><font color="#0000ff">public</font> <font color="#0000ff">void</font> FailToRegsiterUser()<br>{<br>&nbsp;&nbsp;<font color="#0000ff">using</font> (<font color="#0000ff">var</font> fixture = <font color="#0000ff">new</font> FixtutureInit(<font color="#A31515">"http://localhost/registration.aspx"</font>))<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//INIT</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> page = <font color="#0000ff">new</font> RegistrationView();<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> controls = CreateControls();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"EmailText"</font>] <font color="#0000ff">as</font> TextBox).Text = <font color="#A31515">"exists@test.com"</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"SecretPhraseText"</font>] <font color="#0000ff">as</font> TextBox).Text = <font color="#A31515">"bla-bla"</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;(controls[<font color="#A31515">"PasswordText"</font>] <font color="#0000ff">as</font> TextBox).Text = <font color="#A31515">"test_pass2"</font>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//ACT (post back)</font><br>&nbsp;&nbsp;&nbsp;&nbsp;page._Page_Load(<font color="#2B91AF">HttpContext</font>.Current, controls, <font color="#0000ff">new</font> <font color="#0000ff">object</font>(), <font color="#0000ff">new</font> <font color="#2B91AF">EventArgs</font>(), <font color="#0000ff">true</font>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#008000">//POST</font><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> expected = <font color="#A31515">@"Sorry, but user with same e-mail is already registered on site.&#60;br /&#62;&#60;br /&#62;Please try register again."</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;Assert.That((controls[<font color="#A31515">"FailMessage"</font>] <font color="#0000ff">as</font> HtmlGenericControl).InnerHtml, Is.EqualTo(expected));<br>&nbsp;&nbsp;&nbsp;&nbsp;Assert.That((controls[<font color="#A31515">"RegistrationMultiView"</font>] <font color="#0000ff">as</font> MultiView).GetActiveView(), Is.EqualTo((controls[<font color="#A31515">"FailedForm"</font>] <font color="#0000ff">as</font> View)));<br>&nbsp;&nbsp;}<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
Для реализации тестового сценария необходимо уже иметь такую учетную запись. Тут мы снова обращаемя к DbScript. На этот раз добавим код создания нового объекта, в методе Init.
<br />
<br />
<blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">namespace</font> WebApplication.Tests.Framework<br>{<br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">class</font> DbScript : IDisposable<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> WebSiteModelDataContext _model = <font color="#0000ff">new</font> WebSiteModelDataContext();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> DbScript()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Init();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> <font color="#0000ff">void</font> Init()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddTestUser();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">private</font> <font color="#0000ff">void</font> AddTestUser()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> user = <font color="#0000ff">new</font> User()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Email = <font color="#A31515">"exists@test.com"</font>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SecretPhrase = <font color="#A31515">"bla-bla"</font>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Password = <font color="#A31515">"test_pass2"</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_model.Users.InsertOnSubmit(user);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_model.SubmitChanges();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote>
<br />
<br />
<h3>Заключение</h3>
<br />
<br />
Вопреки многим упрекам, что ASP.net Web Forms не пригоден (или крайне труден) для юнит тестирования, я с этим категорически не согласен. Для ASP.net Web Forms, при правльном подходе к делу, и соблюдении простых принципов, очень гладко ложится на методику разработки с тестами. Поэтому тесты, для ASP.net Web Forms могут и должны разрабатыватся.  
<br />
<br />
Идеи не являются исчерпывающими, и естесвенно должны расширятся (или наоборот, сужатся) в зависимости от практической нужны и конкретных обстоятельств. Исходный код проекта можно скачать <a href="http://docs.google.com/leaf?id=0Bz70dGvwjh5zNWVkN2Y5ZjctYjEwYy00NjQ4LThlY2ItN2U2NGU5OWUyZDhh&hl=en">отсюда</a>.</div>
