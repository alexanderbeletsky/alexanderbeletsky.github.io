---
layout: post
title: "Web development: Реализация бизнес объекта"
date: 2010-04-30T11:12:00+03:00
comments: false
categories:
 - Mocks
 - asp.net
 - TDD
---

<div class='post'>
<p>В прошлой статье я начал рассмотрение общих вопросов разработки под веб с ASP.net (C#) 3.5. Сейчас рассмотрим более детальный пример, в котором я покажу одной из бизнес функций для сайта.<br /></p><br /><p><br />Веб сайт, на который надо добавить страницу регистрации.  Лайаут страницы регистрации выглядит следующим образом (шаблон сайта взят http://www.oswd.org/):<br /></p><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_stL4bIIuRUs/S9qTDBP-n_I/AAAAAAAAGlA/-9spmhCw2sk/s1600/website.registration.page.jpg"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 400px; height: 252px;" src="http://3.bp.blogspot.com/_stL4bIIuRUs/S9qTDBP-n_I/AAAAAAAAGlA/-9spmhCw2sk/s400/website.registration.page.jpg" border="0" alt="" id="BLOGGER_PHOTO_ID_5465842777851863026" /></a><br /><p><br />Регистрация, это функция данного сайта, поэтому, как и все другие функции она будет реализована в библиотеке BLL (busines logic layer). Начнем, как обычно, с тестов. В проект Company.Product.BLL.Test добаляем новую фикстуру и первый, самый простой тест.<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">using</font> System;<br><font color="#0000ff">using</font> System.Collections.<font color="#2B91AF">Generic</font>;<br><font color="#0000ff">using</font> System.Linq;<br><font color="#0000ff">using</font> System.Text;<br><font color="#0000ff">using</font> NUnit.Framework;<br><br><font color="#0000ff">namespace</font> Company.Product.BLL.Tests<br>{<br>&nbsp;&nbsp;[TestFixture]<br>&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">class</font> RegistrationTests<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;[Test]<br>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">void</font> Smoke()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">var</font> t = <font color="#0000ff">new</font> Registration();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;}<br>}</font><br><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Данный тест лишь проверяет, что существет определение Registration и объект класса может успешно создан. Может показатся, что такой тест лишний, но я предпочитаю всегда начинать именно с него.<br /></p><br /><p><br />Добавим Registration.cs класс в проект  Company.Product.BLL, сделаем тестовый проект собирабельным и запустим тест. Тест будет зеленым, а это значит, что пора начинать.<br /></p><br /><span style="font-weight:bold;">Бизнес требования</span><br /><p><br />Какие же конкретные действия мы ожидаем от страницы регистрации? Запишем их:<br /><br><br />- если регистрация прошла успешно, показать приветсвие и перевести на главную страницу<br><br />- если пользователь с таким имейлом уже есть в системе, вывести предупреждение<br><br />- если во время регистрации произошла ошибка, показать сведения об ошибке пользователю<br><br /></p><br /><br/><br /><p><br />По моему это самое необходимое.. Если что-то будет нужно дополнительно, добавим в процессе реализации.<br /></p><br /><br/><br /><span style="font-weight:bold;">Подготовительные действия</span><br /><br><br /><p><br />Пока что Registration имеет только конструктор по умолчанию. Этого явно не достаточно, ведь бизнес объекту необходимо откуда-то получать данные.. а также передавать информацию в отображение. Поменяем конструкор следующи образом:<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">using</font> System;<br><font color="#0000ff">using</font> System.Collections.<font color="#2B91AF">Generic</font>;<br><font color="#0000ff">using</font> System.Linq;<br><font color="#0000ff">using</font> System.Text;<br><font color="#0000ff">using</font> Company.Projects.Views;<br><font color="#0000ff">using</font> Company.Product.DAL;<br><br><font color="#0000ff">namespace</font> Company.Product.BLL<br>{<br>&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">class</font> Registration<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">private</font> IRegistrationView _view;<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">private</font> IRegistrationData _data;<br><br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">public</font> Registration(IRegistrationView view, IRegistrationData data)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _view = view;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _data = data;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; }<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Соответсвенно в проекты View и DAL добавим декларации интерфейсов IRegistrationView, IRegistrationData, которые пока что не содержат ни одного метода. Это позволит собрать проект BLL, но не тестовый проект.<br /></p><br /><br><br /><p><br />В тестовый проект добавим фолдер Mocks, а в него два класса, RegistrationViewMock и RegistrationDataMock, которые реализовывают интерфейсы отображения и данных. Также нужно добавить референсы на View и DAL проекты.<br /></p><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_stL4bIIuRUs/S9qVJmJkAVI/AAAAAAAAGlI/f0VsiTmFbfw/s1600/website.proj.files.jpg"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 280px; height: 400px;" src="http://3.bp.blogspot.com/_stL4bIIuRUs/S9qVJmJkAVI/AAAAAAAAGlI/f0VsiTmFbfw/s400/website.proj.files.jpg" border="0" alt=""id="BLOGGER_PHOTO_ID_5465845089859535186" /></a><br /><br><br /><p><br />Смоук тест после модификаций выглядит следующим образом<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black">[Test]<br><font color="#0000ff">public</font> <font color="#0000ff">void</font> Smoke()<br>{<br>&nbsp; <font color="#0000ff">var</font> t = <font color="#0000ff">new</font> Registration(<font color="#0000ff">new</font> RegistrationViewMock(), <font color="#0000ff">new</font> RegistrationDataMock());<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Забегая вперед отмечу, что почти все бизнес объекты имеют схожий конструктор.. принимающий 2 аргумента - отображение и данные (хотя не исключены и частные случаи, когда объекту нужны только отображение или, наоборот, только данные).<br /></p><br /><br><br /><p><br />Тестовый проект запускается и собирается, поехали дальше.<br /></p><br /><br><br /><span style="font-weight:bold;">Регистрация нового пользователя</span><br /><br><br /><p><br />Объект обладает методом регистрации, в который передаем и-мейл, секретную фразу и пароль, если все ОК, то у отображения будет вызван метод о успешной регистрации.<br /></p><br /><br/><br /><p><br />Реализуем данное требование в виде теста.<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black">[Test]<br><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterNewUser()<br>{<br>&nbsp; <font color="#008000">//INIT</font><br>&nbsp; <font color="#0000ff">var</font> view = <font color="#0000ff">new</font> RegistrationViewMock();<br>&nbsp; <font color="#0000ff">var</font> data = <font color="#0000ff">new</font> RegistrationDataMock();<br>&nbsp; <font color="#0000ff">var</font> register = <font color="#0000ff">new</font> Registration(view, data);<br><br>&nbsp; <font color="#008000">//ACT</font><br>&nbsp; register.RegisterUser(<font color="#A31515">"email"</font>, <font color="#A31515">"secret phrase"</font>, <font color="#A31515">"password"</font>);<br><br>&nbsp; <font color="#008000">//POST</font><br>&nbsp; Assert.That(view.RegisterSuccess, Is.True);<br>}</font><br><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Добавим реализацию метода RegisterUser в бизнес объект (просто пустой метод), мок-объект отображения будет таким,<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">class</font> RegistrationViewMock : IRegistrationView<br>{<br>&nbsp; <font color="#0000ff">private</font> <font color="#0000ff">bool</font> _success = <font color="#0000ff">false</font>;<br><br>&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">bool</font> RegisterSuccess<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">get</font> { <font color="#0000ff">return</font> _success; }<br>&nbsp; }<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />Тест валится с сообщением:<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black">TestCase 'Company.Product.BLL.Tests.RegistrationTests.RegisterNewUser' failed:<br> Expected: True<br> But was:&nbsp;False<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />(это правильно, вообще тесты надо создавать так, чтобы первый запуск всегда был неудачным).<br /></p><br /><br/><br /><p><br />Вернемся к реализации, и не будем очень долго думать над ней.. делаем лишь то, что необходимо для прохождения теста, а именно<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>{<br>&nbsp;&nbsp;_view.Success();<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />Используя средства студии генерируем новый метод интерфейса View, и добавляем реализацию метода в мок-объект.<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">#region</font> IRegistrationView Members<br><br><font color="#0000ff">public</font> <font color="#0000ff">void</font> Success()<br>{<br>&nbsp; _success = <font color="#0000ff">true</font>;<br>}<br><br><font color="#0000ff">#endregion</font><br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />Перезапустим тесты, и получим зеленый результат.<br /></p><br /><br/><br /><span style="font-weight:bold;">Регистрация пользователя с одинаковым имейлом</span><br /><br><br /><p><br />Исходя из наших требований имейл выступает ключем, и он не должен повторятся. Поэтому если происходит попытка регистрации пользователя с таким же имейлом, это дожно проводить к неудаче.<br /></p><br /><br/><br /><p><br />В коде это предлождение выглядит так,<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black">[Test]<br><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUserWithSameEmail()<br>{<br>&nbsp; <font color="#008000">//INIT</font><br>&nbsp; <font color="#0000ff">var</font> view = <font color="#0000ff">new</font> RegistrationViewMock();<br>&nbsp; <font color="#0000ff">var</font> data = <font color="#0000ff">new</font> RegistrationDataMock();<br>&nbsp; <font color="#0000ff">var</font> register = <font color="#0000ff">new</font> Registration(view, data);<br><br>&nbsp; <font color="#008000">//ACT</font><br>&nbsp; register.RegisterUser(<font color="#A31515">"email"</font>, <font color="#A31515">"secret phrase"</font>, <font color="#A31515">"password"</font>);<br>&nbsp; register.RegisterUser(<font color="#A31515">"email"</font>, <font color="#A31515">"secret phrase"</font>, <font color="#A31515">"password"</font>);<br><br>&nbsp; <font color="#008000">//POST</font><br>&nbsp; Assert.That(view.RegisterSuccess, Is.False);<br>&nbsp; Assert.That(view.FailureMessage, Is.EqualTo(<font color="#A31515">"Sorry, but user with same e-mail is already registered on site"</font>));<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />В мок для отображения добавим новое свойство типа string, FailureMessage. Запустим тест, и получим красный результат.<br /></p><br /><blockquote><code><font size="2" face="Courier New" color="black">TestCase <font color="#A31515">'Company.Product.BLL.Tests.RegistrationTests.RegisterUserWithSameEmail'</font><br>failed:<br> Expected: False<br> But was:&nbsp;True<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />Добавим самую простую реализацию, которая приходит в голову:<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>{<br>&nbsp; <font color="#0000ff">if</font> (_email == email)<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; _view.Fail(<font color="#A31515">"Sorry, but user with same e-mail is already registered on site"</font>);<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">return</font>;<br>&nbsp; }<br><br>&nbsp; _email = email;<br>&nbsp; _view.Success();<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />Для отображения сгенеруем новый метод Fail, и реализуем его в моке.<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> Fail(<font color="#0000ff">string</font> message)<br>{<br>&nbsp; _failureMessage = message;<br>&nbsp; _success = <font color="#0000ff">false</font>;<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br/><br /><p><br />ОК, запустим тест.. и получим зеленый результат!<br /></p><br /><br/><br /><p><br />Теперь на секунду остановимся и задумаемся над корректностью теста - ведь, объект бизнес логики Registration это не персистеный объект, он живет на протяжении жизни страницы, и при открытии новой страницы (или пост-беке) объект будет создан заново. Наш тест это совершенно не учитывает.<br /></p><br /><br/><br /><p><br />Корректный сценарий использования выглядит так,<br /></p><br /><br/><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#008000">//ACT</font><br>register.RegisterUser(<font color="#A31515">"email"</font>, <font color="#A31515">"secret phrase"</font>, <font color="#A31515">"password"</font>);<br>register = <font color="#0000ff">new</font> Registration(view, data);<br>register.RegisterUser(<font color="#A31515">"email"</font>, <font color="#A31515">"secret phrase"</font>, <font color="#A31515">"password"</font>);<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Естесвенно, что тест не проходит, так как наша текущая реализация не является корректной. Нам нужен персистентый объект, который сможет хранить информацию вне объекта бизнес логики. Такие функции должен предоставлять DAL приложения. Итак, начнем задействовать объект данных.<br /></p><br /><br><br /><p><br />Изменим реализацию метода регистрации<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>{<br>&nbsp; <font color="#0000ff">if</font> (_data.IsUserExists(email))<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; _view.Fail(<font color="#A31515">"Sorry, but user with same e-mail is already registered on site"</font>);<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">return</font>;<br>&nbsp; }<br><br>&nbsp; _data.RegisterUser(email, secret, password);<br>&nbsp; _view.Success();<br>}</font><br><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />И сгенирируем 2 новых метода у интерфейса данных.<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">#region</font> IRegistrationData Members<br><br><font color="#0000ff">public</font> <font color="#0000ff">bool</font> IsUserExists(<font color="#0000ff">string</font> email)<br>{<br>&nbsp; <font color="#0000ff">throw</font> <font color="#0000ff">new</font> NotImplementedException();<br>}<br><br><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>{<br>&nbsp; <font color="#0000ff">throw</font> <font color="#0000ff">new</font> NotImplementedException();<br>}<br><br><font color="#0000ff">#endregion</font><br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Тесты не проходят, потому как оба метода выбрасывают исключения. Добавим реализацию,<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">#region</font> IRegistrationData Members<br><br><font color="#0000ff">public</font> <font color="#0000ff">bool</font> IsUserExists(<font color="#0000ff">string</font> email)<br>{<br>&nbsp; <font color="#0000ff">return</font> <font color="#0000ff">false</font>;<br>}<br><br><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>{<br><br>}<br><br><font color="#0000ff">#endregion</font><br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Перезапустим тест, он все еще красный, но уже по другой причине:<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black">TestCase <font color="#A31515">'Company.Product.BLL.Tests.RegistrationTests.RegisterUserWithSameEmail'</font><br>failed:<br> Expected: False<br> But was:&nbsp;True<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Проблема в том, что регистрация проходит успешно, а мы ожидаем, что должен быть фейл. Просто мок объекта данных ведет себя не совсем так, как должен вести себя в действительности. Добавим нужное поведение.<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">class</font> RegistrationDataMock : IRegistrationData<br>{<br>&nbsp; <font color="#0000ff">private</font> IList&#60;<font color="#0000ff">string</font>&#62; _userEmails = <font color="#0000ff">new</font> <font color="#2B91AF">List</font>&#60;<font color="#0000ff">string</font>&#62;();<br><br>&nbsp; <font color="#0000ff">#region</font> IRegistrationData Members<br><br>&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">bool</font> IsUserExists(<font color="#0000ff">string</font> email)<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">return</font> (_userEmails.Contains(email));<br>&nbsp; }<br><br>&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#008000">//register user</font><br>&nbsp;&nbsp;&nbsp; _userEmails.Add(email);<br>&nbsp; }<br><br>&nbsp; <font color="#0000ff">#endregion</font><br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />После сборки и запуска, тест зеленый.<br /></p><br /><br><br /><span style="font-weight:bold;">Неожиданная ошибка во время регистрации</span><br /><br><br /><p><br />Мы должны учитывать тот факт, что DAL будет обращатся к реальному источнику данных, а это значит, что мы должны быть готовы к тому, что методы DAL могут генерировать исключения.<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black">[Test]<br><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterFailed()<br>{<br>&nbsp; <font color="#008000">//INIT</font><br>&nbsp; <font color="#0000ff">bool</font> failOnRegister = <font color="#0000ff">true</font>;<br>&nbsp; <font color="#0000ff">var</font> view = <font color="#0000ff">new</font> RegistrationViewMock();<br>&nbsp; <font color="#0000ff">var</font> data = <font color="#0000ff">new</font> RegistrationDataMock(failOnRegister);<br>&nbsp; <font color="#0000ff">var</font> register = <font color="#0000ff">new</font> Registration(view, data);<br><br>&nbsp; <font color="#008000">//ACT</font><br>&nbsp; register.RegisterUser(<font color="#A31515">"email"</font>, <font color="#A31515">"secret phrase"</font>, <font color="#A31515">"password"</font>);<br><br>&nbsp; <font color="#008000">//POST</font><br>&nbsp; Assert.That(view.RegisterSuccess, Is.False);<br>&nbsp; Assert.That(view.FailureMessage, Is.EqualTo(<font color="#A31515">"Sorry, but unexcpected exception happend during operation. Please try to register later"</font>));<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Констуруктор дата объекта модифицируем так, чтобы он принимал флаг об успешном или не успешном прохождении регистрации. А метод регистрации поменяем так, чтобы он учитывал данный флаг.<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>{<br>&nbsp; <font color="#0000ff">if</font> (_fail)<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception(<font color="#A31515">"RegisterUser method failed!"</font>);<br>&nbsp; }<br><br>&nbsp; <font color="#008000">//register user</font><br>&nbsp; _userEmails.Add(email);<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Результат запуска теста будет следующим,<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black">TestCase <font color="#A31515">'Company.Product.BLL.Tests.RegistrationTests.RegisterFailed'</font><br>failed: System.Exception : RegisterUser method failed!<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Проблема в том, что бизнес объект не производит обработку исключений. Этого быть не должно, исключения дожны быть обработаны бизнес объектом и информация о проблемах должна передоваться в отображение.<br /></p><br /><br><br /><p><br />Заключим все обращения к DAL в try/catch блок. И если исключение произошло, сообщим об этом в отображение.<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>{<br>&nbsp; <font color="#0000ff">try</font><br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">if</font> (_data.IsUserExists(email))<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _view.Fail(<font color="#A31515">"Sorry, but user with same e-mail is already registered on site"</font>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">return</font>;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; _data.RegisterUser(email, secret, password);<br>&nbsp;&nbsp;&nbsp; _view.Success();<br>&nbsp; }<br>&nbsp; <font color="#0000ff">catch</font> (Exception)<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; _view.Fail(<font color="#A31515">"Sorry, but unexcpected exception happend during operation. Please try to register later"</font>);<br>&nbsp; }<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Самое время перезапустить все тесты, дабы убедится что ничего не сломано предыдущимим изменениями.<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black">------ Test started: <font color="#2B91AF">Assembly</font>: Company.Product.BLL.Tests.dll ------<br><br><br>4 passed, 0 failed, 0 skipped, took 1,58 seconds (NUnit 2.4).<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><span style="font-weight:bold;">Заключение</span><br /><p><br />Посмотрим назад и оценим проделанную работу.<br /></p><br /><br><br /><p><br />Интерфейсы отображения и данных:<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">namespace</font> Company.Product.DAL<br>{<br>&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">interface</font> IRegistrationData<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">bool</font> IsUserExists(<font color="#0000ff">string</font> email);<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password);<br>&nbsp; }<br>}<br><br><font color="#0000ff">namespace</font> Company.Projects.Views<br>{<br>&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">interface</font> IRegistrationView<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">void</font> Success();<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">void</font> Fail(<font color="#0000ff">string</font> p);<br>&nbsp; }<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Код бизнес объекта:<br /></p><br /><br><br /><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">namespace</font> Company.Product.BLL<br>{<br>&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">class</font> Registration<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">private</font> IRegistrationView _view;<br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">private</font> IRegistrationData _data;<br><br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">public</font> Registration(IRegistrationView view, IRegistrationData data)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _view = view;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _data = data;<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; <font color="#0000ff">public</font> <font color="#0000ff">void</font> RegisterUser(<font color="#0000ff">string</font> email, <font color="#0000ff">string</font> secret, <font color="#0000ff">string</font> password)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">try</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">if</font> (_data.IsUserExists(email))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _view.Fail(<font color="#A31515">"Sorry, but user with same e-mail is already registered on site"</font>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">return</font>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _data.RegisterUser(email, secret, password);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _view.Success();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font color="#0000ff">catch</font> (Exception)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _view.Fail(<font color="#A31515">"Sorry, but unexcpected exception happend during operation. Please try to register later"</font>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; }<br>}<br></font><br><font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><br /><br><br /><p><br />Мы прошли путь от бизнес требований, к реализации бизнес объекта, через тестирование. Именно бизнес объект стоял в центре разработки, и его нужды определяют конкретные интерфейсы IView и IData. Мы с состоянии протестировать бизнес объект даже не задумываясь как конкретно будет реализован DAL или View, но теперь мы точно знаем что именно необходимо получить от этих объектов.<br /></p><br /><br><br /><p><br />В следующей статье мы продолжим реализацию, и создадим реальный DAL класс, реализующий интрефейс, требуемый бизнес объектом.<br /></p><br /><br></div>
