---
layout: post
title: "Inside ASP.NET MVC: ControllerBuilder class"
date: 2011-07-09T12:28:00+03:00
comments: false
categories:
 - InsideMVC
 - MVC
 - asp.net
---

<div class='post'>
<p>
Integral part of <code>MvcHanlder</code> is <code>ControllerBuilder</code>. <code>ControllerBuilder</code> is a singleton that is responsible to produce <code>IControllerFactory</code> instance. 
</p>
<a href="https://lh6.googleusercontent.com/-DCwP650y9-U/ThgeFaCgXPI/AAAAAAAAHgU/A0dkfOHBGqo/controllerbuilder-0.png">
<img src="https://lh6.googleusercontent.com/-DCwP650y9-U/ThgeFaCgXPI/AAAAAAAAHgU/A0dkfOHBGqo/controllerbuilder-0.png" alt="controller builder" />
</a>
<h2>Construction</h2>
<p>
<code>ControllerBuilder</code> have 2 constructors, the default one and one with parameter. One of the major changes between MVC2 and MVC3 was the improvements of <a href="http://bradwilson.typepad.com/blog/2010/07/service-location-pt1-introduction.html">Dependency Injection</a>. MVC is using <a href="http://en.wikipedia.org/wiki/Service_locator_pattern">Service Locator</a> pattern for resolving dependencies.Default constructor calls constructor with parameter, passing <code>null</code> as argument, saying that <code>SingleServiceResolver</code> object have to be used as default service resolver.
</p>
<p>
Please note, even if MVC is using Service Locator to locate different entities (like Controllers, Views, Filters) and so on, it does not include any kind on IoC frameworks itself. 
</p>
<h2>Controller factory get/set</h2>
<p>
<code>MvcHanlder</code> uses <code>GetControllerFactory</code> method to get controller factory.
</p>
<a href="https://lh5.googleusercontent.com/-NVekFX42y9E/ThgeFNkIbvI/AAAAAAAAHgM/r_r--YJdVco/controllerbuilder-1.png">
<img src="https://lh5.googleusercontent.com/-NVekFX42y9E/ThgeFNkIbvI/AAAAAAAAHgM/r_r--YJdVco/controllerbuilder-1.png" alt="controller builder" />
</a>
<p>
Method itself is fairly simple, it just ask service resolver to get current instance of controller factory. 
</p>
<p>
Setter method allows you to change default controller factory with custom one. This an extremely useful then you want to change the way of Controller creation. The most useful case is delegate the controller creation to some DI container (Ninject, Unity, StructureMap) to allowing your application to get benefits of using IoC principles.
</p>
<p>
Basically, IControllerFactory is a strategy of controller creation. Depending of implementation it might use different techniques, later on we will see how <code>DefaultControllerFactory</code> works.
</p>
<p>As and additional option, it is possible to supply custom controller factory just from the specific type</p>
<a href="https://lh3.googleusercontent.com/-5z7-swBhCaI/ThgeFWwleXI/AAAAAAAAHgQ/En6NIHHkYWY/controllerbuilder-2.png">
<img src="https://lh3.googleusercontent.com/-5z7-swBhCaI/ThgeFWwleXI/AAAAAAAAHgQ/En6NIHHkYWY/controllerbuilder-2.png" alt="controller builder" />
</a>
<h2>Substitute default controller factory</h2>
<p>
As you see, we have to options of substitution default factory: 
</p>
<ol>
<li>Call SetControllerFactory method and pass custom object into.</li>
<li>Implementing new IDependencyResolver.</li>
</ol>
<p>
Here is an example of how that could be done (please note, it is just demostartion.. you typically should not use both approaches in the same type).
</p>
<a href="https://lh3.googleusercontent.com/-wolhzYhyE1w/ThgeFF2OawI/AAAAAAAAHgI/fLPsMlTuAzQ/controllerbuilder-3.png">
<img src="https://lh3.googleusercontent.com/-wolhzYhyE1w/ThgeFF2OawI/AAAAAAAAHgI/fLPsMlTuAzQ/controllerbuilder-3.png" alt="controller builder" />
</a>
<h2>Conclusions</h2>
<p>
<code>ControllerBuilder</code> is simple class that delegates responsibility to <code>IResolver</code> which is responsible to resolve <code>IControllerFactory</code> instance. <code>IControllerFactory</code> is a strategy of controllers creation. <code>ControllerBuilder</code> is designed in a way of chaning this strategy easily, either by using custom <code>IControllerFactory</code> or by custom <code>IDependencyResolver</code>.
</p>
<h2>What is next?</h2>
<p>
Next we are going to look closer into <code>SingleServiceResolver</code> and see how it actually acts for resolving types.
</p>
<p>
Previous: <a href="http://www.beletsky.net/2011/06/inside-aspnet-mvc-all-begins-here.html">Inside ASP.NET MVC: All begins here - MvcHanlder</a>
</p></div>
