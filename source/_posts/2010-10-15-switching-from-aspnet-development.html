---
layout: post
title: "Switching from ASP.NET development server (Cassini) to IIS with MVC applications"
date: 2010-10-15T12:11:00+03:00
comments: false
categories:
 - MVC
 - AJAX
 - Tips
 - asp.net
---

<div class='post'>
<p>Start developing new applications on IIS already is probably good idea, since it is IIS where you application is finally landed to. Working with Cassini is great, cause it fast, requires no maintenance, very easy to start. But it could hide some issues that would surprise you during deployment. </p><p>Recently I've decided to switch my current Asp.net MVC application from Cassini to IIS. It is done very easy, just go to project, Web tab -> Use local IIS Web Server. Select the option and then click on "Create a virtual directory", to create a virtual directory for application.  </p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://1.bp.blogspot.com/_stL4bIIuRUs/TLga9AQeq6I/AAAAAAAAG-g/dRc-bMB-Yzc/s1600/projproperties.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 400px; height: 122px;" src="http://1.bp.blogspot.com/_stL4bIIuRUs/TLga9AQeq6I/AAAAAAAAG-g/dRc-bMB-Yzc/s400/projproperties.png" border="0" alt=""id="BLOGGER_PHOTO_ID_5528198177940745122" /></a> <p>But after I started, application just failed. I'll share the problems I met and how I fix them. </p><h2>IIS identity impersonation and path credentials</h2><p>To make sure your SQL database works fine, you have to configure identity impersonation for application pool and path credentials for folder. </p><p>Go to ISS Management, Application Pools, DefaulAppPool, (you could you another app pool for you application), Advanced Settings, Process Model, Identity and set it for your account (you should have admin permissions on this machine). </p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://4.bp.blogspot.com/_stL4bIIuRUs/TLgbJbY04VI/AAAAAAAAG-o/qhDRoBlKCng/s1600/processidentity.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 400px; height: 338px;" src="http://4.bp.blogspot.com/_stL4bIIuRUs/TLgbJbY04VI/AAAAAAAAG-o/qhDRoBlKCng/s400/processidentity.png" border="0" alt=""id="Img1" /></a> <p>Go to Virtual folder, Basic Setting, Connect As..., use you credentials. </p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://3.bp.blogspot.com/_stL4bIIuRUs/TLgbRJAUThI/AAAAAAAAG-w/ssQc42zjtgw/s1600/pathcredentials.png"><img style="display:block; margin:0px auto 10px; text-align:center;cursor:pointer; cursor:hand;width: 400px; height: 281px;" src="http://3.bp.blogspot.com/_stL4bIIuRUs/TLgbRJAUThI/AAAAAAAAG-w/ssQc42zjtgw/s400/pathcredentials.png" border="0" alt=""id="Img2" /></a> <h2>JavaScript references from Master page </h2><p>On my master page I've referenced number of javascript files, as jQuery, jPost etc. I did it like that, </p><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">&#60;</font><font color="#800000">script</font> <font color="#ff0000">src</font><font color="#0000ff">="/Scripts/jquery-1.4.1.min.js"</font> <font color="#ff0000">type</font><font color="#0000ff">="text/javascript"</font><font color="#0000ff">&#62;&#60;/</font><font color="#800000">script</font><font color="#0000ff">&#62;</font>&nbsp;&nbsp;&nbsp;&nbsp; <br />
&#60;script src=<font color="#A31515">"/Scripts/jquery.blockUI.js"</font> type=<font color="#A31515">"text/javascript"</font>&#62;&#60;/script&#62;<br />
&#60;script src=<font color="#A31515">"/Scripts/json2.js"</font> type=<font color="#A31515">"text/javascript"</font>&#62;&#60;/script&#62;&nbsp;&nbsp;&nbsp;&nbsp; <br />
&#60;script src=<font color="#A31515">"/Scripts/jquery.postJson.js"</font> type=<font color="#A31515">"text/javascript"</font>&#62;<font color="#0000ff">&#60;/</font><font color="#800000">script</font><font color="#0000ff">&#62;</font><br />
</font><br />
<font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><p>That worked fine on Cassini, because virtual is "/", but as on IIS if you use code like that, it would have some unexpected behavior. Namely, on each view that uses this Master script reference will be mapped differently. For http://localhost/Tracky/Home, it would be be searching for javascript by such URL http://localhost/Tracky/Home/Scripts/jquery-1.4.1.min. And failed to load that. Fortunately there is a way to fix that. Instead of, </p><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">&#60;</font><font color="#800000">script</font> <font color="#ff0000">src</font><font color="#0000ff">="/Scripts/jquery-1.4.1.min.js"</font> <font color="#ff0000">type</font><font color="#0000ff">="text/javascript"</font><font color="#0000ff">&#62;&#60;/</font><font color="#800000">script</font><font color="#0000ff">&#62;</font><br />
</font></code></blockquote><p>Use </p><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">&#60;</font><font color="#800000">script</font> <font color="#ff0000">src</font><font color="#0000ff">="&#60;%: Url.Content("</font>~/<font color="#ff0000">Scripts</font>/<font color="#ff0000">jquery-1</font>.<font color="#ff0000">4</font>.<font color="#ff0000">1</font>.<font color="#ff0000">min</font>.<font color="#ff0000">js</font><font color="#0000ff">") %&#62;"</font> <font color="#ff0000">type</font><font color="#0000ff">="text/javascript"</font><font color="#0000ff">&#62;&#60;/</font><font color="#800000">script</font><font color="#0000ff">&#62;</font><br />
</font></code></blockquote><p>Url.Content method will properly create a absolute path to script file. </p><p>Please make sure, that your Master page is inherited from System.Web.Mvc.ViewMasterPage. </p><blockquote><code><font size="2" face="Courier New" color="black"><font color="#0000ff">namespace</font> Web.Areas.Public<br />
{<br />
&nbsp;&nbsp;[CoverageExcludeAttribute]<br />
&nbsp;&nbsp;<font color="#0000ff">public</font> <font color="#0000ff">partial</font> <font color="#0000ff">class</font> Public : System.Web.Mvc.ViewMasterPage <br />
&nbsp;&nbsp;{<br />
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">protected</font> <font color="#0000ff">void</font> Page_Load(<font color="#0000ff">object</font> sender, <font color="#2B91AF">EventArgs</font> e)<br />
&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<br />
&nbsp;&nbsp;&nbsp;&nbsp;}<br />
&nbsp;&nbsp;}<br />
}</font><br />
<br />
<font size="1" color="gray">* This source code was highlighted with <a href="http://virtser.net/blog/post/source-code-highlighter.aspx"><font size="1" color="gray">Source Code Highlighter</font></a>.</font></code></blockquote><p>I've spend some time, trying to understand why <a href="http://stackoverflow.com/questions/3912508/using-url-content-in-asp-net-mvc-2-0">Url.Content does not work for me</a>, thanks to <a href="http://twitter.com/#!/erikzaadi">erikzaadi</a>. </p><h2>All redirected URL have to prefixed with ~/</h2><p>If you have Redirection somewhere, make sure that redirect URL is prefixed with ~/ (except you explicitly mean it). If you do <code>Redirect("/Pubic/Home")</code> from /Public/Registration, for instance, absolute URL will be http://localhost/Tracky/Public/Registration/Public/Home, something not expected. With ~/ it will be correctly redirected to http://localhost/Tracky/Public/Home. </p><h2>Use absolute path for AJAX posts</h2><p>If you somewhere have a javascript code like this: </p><blockquote><code><font size="2" face="Courier New" color="black">$.post('/GetAllTasks/' + userId, null, callback, 'json'); </font></code></blockquote><p>It won't work either, you have to provide absolute path for resource. </p><blockquote><code><font size="2" face="Courier New" color="black">$.post(api + '/GetAllTasks/' + userId, null, callback, 'json'); </font></code></blockquote><p>I receive the API folder from a hidden input on page, initialized with a value from ViewData, which in its turn intialized in controller, using <code>VirtualPathUtility</code> class. </p><h2>Conclusions</h2><p>These are just some issues I met during my switching after I done all above application started to work fine. If you had some other issues during transition to IIS, please make you comments. </p><p>You can review changes I did for my project in this <a href="http://github.com/alexbeletsky/Trackyourtasks.net/commit/0ddbfb2df4a0148a3d4133e033ec0e084a066bc9">commit</a>. </p></div>
