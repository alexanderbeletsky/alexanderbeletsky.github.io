---
layout: post
title: "Continuous Delivery: Make it work"
date: 2011-05-11T10:27:00+03:00
comments: false
categories:
 - Continuous
---

<div class='post'>
<p>
As soon as we <a href="http://www.beletsky.net/2011/05/continues-production-setup-and-run.html">setup</a> project infrastructure in a way that build and deploy is done by one batch command, we are ready to run this process continuously. It is possible to take any CI server you want, I stopped on <a href="http://jenkins-ci.org/">Jenkins</a>.. basically it contains everything I need. But before start with Jenkins, let's one more time take a look current infrastructure and goals.
</p>
<h2>Git branching model</h2>
<p>
There is great <a href="http://nvie.com/posts/a-successful-git-branching-model">article</a> on that topic, I used main ideas from that. So, I have 2 branches in my <code>origin</code> that exists all the time. They are: <code>master</code> and <code>development</code>. All pushes I do during implementation are going to <code>development</code> branch. No direct pushes are made to <code>master</code> at all (there are some exceptions of cause, but I try to follow that rule). As soon as code in <code>development</code> is stabilized, I prepare special <code>release</code> branch (update version and small clean up there) and <code>release</code> is being merged to <code>master</code> as it tested and everything is fine.
</p>
<h2>Staging and Production environments</h2>
<p>
I define 2 types of environments: Staging and Production. Environment includes: binaries, markup, database, deploy scripts.
</p>
<p>Everything that is being developed are goes to staging environment immediately (and automatically). Production update is being run manually as soon as all testing on Staging are finished. Separation of environments is great idea. Even if we are trying hard to have potentially shippable software during each build, this is not true. It is usually a lot of problems in latest version that need to be fixed before production server update.
</p>
<p>
So, Staging is a result of build/deploy of <code>development</code>; Production is a result of build/deploy of <code>master</code>.
</p>
<p>
In my case, everything you see <a href="http://stage.trackyt.net/">here</a> is a result of build of <a href="https://github.com/alexbeletsky/trackyt.net/tree/development">this</a>. Everything you see <a href="http://www.trackyt.net/">here</a> is a result of <a href="https://github.com/alexbeletsky/trackyt.net">this</a>.
</p>
<h2>What I want to get?</h2>
<p>
I want to have automatic system that would update my <a href="http://stage.trackyt.net/">Staging</a> with every push to <code>development</code> branch and I want automatic system that would update my <a href="http://www.trackyt.net/">Production</a> as soon as <code>master</code> branch is ready to. As it said in <a href="http://www.beletsky.net/2011/04/continues-production-overview-and.html">overview</a> having such system is great reduce of deployment overhead. Let's make this happen!
</p>
<p>
As I said earlier I would use <a href="http://jenkins-ci.org/">Jenkins</a>. Great stuff about this software that is very intuitive! Setup is easy and fun, I would put just a little guidance of process.
</p>
<h2>Local Jenkins server setup</h2>
<p>
As you download Jenkins WAR file, it is easy to start just with <code>java -jar jenkins.war</code>. Now, the dashboard is available at <code>http://localhost:8080/</code>.
</p>
<h3>Plugins</h3>
<p>
First, you should add all required plugins. It already contains some, but some are missing. I've add such to my default configuration:
</p>
<ul>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Git+Plugin">Jenkins GIT plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/Github+Plugin">Github plugin</a></li>
<li><a href="http://wiki.jenkins-ci.org/display/JENKINS/NUnit+Plugin">NUnit Plugin</a></li>
</ul>
<p>
Go to "Manage Jenkins" -> "Manage Plugins" and install missing one.
</p>
<p>
So, my configuration looks like this:
</p>
<!-- plugins.png -->
<img src="https://lh6.googleusercontent.com/_stL4bIIuRUs/Tco7BUnOiGI/AAAAAAAAHZk/XSxs5Y_zrR0/plugins.png" alt="plugins" />
<h3>Configure system</h3>
<p>
Now go to "Manage Jenkins" -> "Configure System" and find "Git" section there. You should provide with your user name and path to Git. I have git in my PATH variable (recommend you do the same).
</p>
<h3>Create new job</h3>
<p>
After basic configuration is done, let's define new job. Go to "New job". In common section you should give your job name and provide with githib path to repository.
</p>
<img src="https://lh5.googleusercontent.com/_stL4bIIuRUs/Tco7A-XTqYI/AAAAAAAAHZg/0kLPsWXWj6k/common-section.png" alt="common section" />
<p>
In Source Control Management: URL to Git repository, Branch to build and Repository browser (optional).
</p>
<!-- SCM.png -->
<img src="https://lh6.googleusercontent.com/_stL4bIIuRUs/Tco7Bh2RuUI/AAAAAAAAHZs/p568dcfUStk/SCM.png" alt="SCM" />
<p>
Build triggers (explain a bit later).
</p>
<!-- build-triggers.png -->
<img src="https://lh4.googleusercontent.com/_stL4bIIuRUs/Tco7A6XC3ZI/AAAAAAAAHZY/X39bPBs9U3Q/build-triggers.png" alt="build-triggers" />
<p>
In Build section you specify commands to build/test/package and to deploy results. See my <a href="http://www.beletsky.net/2011/05/continues-production-setup-and-run.html">previous post</a> for details.
</p>
<!-- build.png -->
<img src="https://lh4.googleusercontent.com/_stL4bIIuRUs/Tco7A76md_I/AAAAAAAAHZc/5JPyCIL5Pek/build.png" alt="build" />
<p>
Finally in Post-build section, specify path to grab artifacts.
</p>
<!-- post-build.png -->
<h3>Test it locally</h3>
<p>
As soon as configuration is done, you can test your build locally. Just start your job and make sure that: build run, tests executed, new database deployed, new application deployed. Basically if everything done correctly in previous <a href="http://www.beletsky.net/2011/05/continues-production-setup-and-run.html">steps</a> you should not experience any troubles. If it is fine that means the configuration is simply ready to be put to production server.
</p>
<h2>Move it to production</h2>
<p>
As it defined, our goal is to update staging and production with out any manual work. The simplest scenario then CI server resides on the same machine as production server.
</p>
<p>
Great thing about Jenkins is that it requires no installation. So, I packed all content of <code>~/User/Jenkins</code> folder and Git into one single package and FTP'ed to my production server. As you unpack, configure Git in PATH variable, setup up your private repository keys it is just simply ready to work. Now, test it remotely - staging and production should be able to update with one single click on Jenkins dashboard.
</p>
<h3>Little adjustments for production server</h3>
<p>
My VPS has Windows auto-update enabled, so It is being rebooted from time to time. As it is being rebooted, you should start Jenkins manually. Fortunately it has really nice feature - Jenkins might be run as <a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins+as+a+Windows+service">Windows Service</a>. This is extremely useful, I recommend to do it from very beginning.
</p>
<h3>Using Github hook to automate build run</h3>
<p>
I want my every commit to <code>development</code> to be tested and to be visible on Stage. As it said in <strong>Configure system</strong> part, you can setup build triggers. With build trigger you can run build just by requesting this URL <code>http://jenkins.server/jobname/build?token=TOKEN</code>.
</p>
<p>
In github repository go to Admin section and setup new hook in "Post Recieve URLs" section, like this:
</p>
<!-- gtihub -->
<img src="https://lh4.googleusercontent.com/_stL4bIIuRUs/TcpDr67qBpI/AAAAAAAAHZ4/bL1s9Lwhh7g/s912/github.png" alt="github" />
<p>
This concludes the setup.
</p>
<h2>Control your builds all the time</h2>
<p>
What we did is only very basic setup, but it already gives a lot of power. It is really easy to track all builds/artifacts/history of changes. Downtime of site is extreamly slow (comparing to manual changes). Dashboard is very convenient to control builds:
</p>
<!-- dashboard -->
<img src="https://lh6.googleusercontent.com/_stL4bIIuRUs/TcpEsDXvmmI/AAAAAAAAHZ8/c7ttFDLm_fA/s912/dashboard.png" alt="dashboard" /></div>
